---
title: "Leaflet_Map_Discharge"
author: "SarahKinz"
date: "7/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(leaflet)
library(sf)
library(raster)
library(dplyr)
library(spData)
library(spDataLarge)
library(tmap)
library(rgdal)
```


Let's create a static map first
```{r}
### reading in and formating discharge data

DEQ_discharge<- read_csv("VDEQ_Springs.csv")

discharge<- DEQ_discharge%>%
  dplyr::select(DEQ_NUMBER, LONGNAD83D, LATNAD83DD,DISCHARGE_GPM)%>%
  filter(DISCHARGE_GPM>=-1)%>%
  group_by(DEQ_NUMBER)%>% 
  summarise(LONGNAD83D, LATNAD83DD, GPM =median(DISCHARGE_GPM))%>%
  distinct()


discharge<- discharge%>%
  mutate(Class= case_when(GPM <= 40 ~ "0-40",
                          GPM > 40 & GPM <=700 ~ "40 - 700",
                          GPM > 700 & GPM <=1400 ~ "700 - 1400",
                          GPM > 1400 ~ "1400-8527"))
  


map_discharge<- st_as_sf(discharge, coords = c("LONGNAD83D","LATNAD83DD"), crs = 4326 )

st_crs(map_discharge)

### Setting the mood... I mean mode

tmap_mode("view")

### Reading in VA shapefile and prepping it

va <- shapefile("VirginiaAdministrativeBoundary.shp/VirginiaCounty.shp")
st_crs(va)

va<-st_as_sf(va)

va<-st_transform(va, crs = 4326)

### reading in the chessy watershed boundary

watersheds <- st_read("Chesapeake_Bay_Watershed_Boundary/Chesapeake_Bay_Watershed_Boundary.shp")

st_crs(watersheds)

watersheds<-st_transform(watersheds, crs = 4326)

sub_basins <- st_read("Chessy_Subbassins/Chesapeake_Bay_Major_Basin_Summary_Groups.shp")

sub_basins<-st_transform(sub_basins, crs = 4326)

test<- map_discharge[sub_basins, ]

### Actually creating the visuals

discharge_map<-
  tm_shape(sub_basins)+
  tm_borders()+
  tm_shape(test)+
  tm_dots("GPM", breaks = c(0,40,700,1400, Inf), size= 0.08, id= "DEQ_NUMBER", title= "Class of Median Discharge (GPM)", palette= "Blues")


  
 # tmap_save(discharge_map, "VA_discharge_map.html")
 
 ### Converting to leaflet format
 
leaflet(test) %>% addTiles() %>%
addMarkers(label= ~ Class, fillColor = ~ Class,
            popup = ~paste0(DEQ_NUMBER, "<br/>Discharge: ", GPM))
 

```


### Messing Around with Layers to Add to the Map
```{r}
chessy_riv_segments<- read_csv("Chesapeake_Bay_Watershed_Model_Phase_6_Land_River_Segments.csv")

# 2058

delivery_factor<- read_csv("DeliveryFactor_CAST.csv")

### 2049

# general_info <- read_csv("PA_general_info.csv")

library(geojsonsf)
library(sf)       ## for sf print methods

test_json<- rgdal::readOGR("CBW_Phase_6_Land_River.geojson")

leaflet(test_json) %>% addTiles()%>% addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
    opacity = 1.0, fillOpacity = 0.5)

test_json<-st_as_sf(test_json)

### 2058

unique(chessy_riv_segments$LndRvrSeg)
```


### CONVERTING TO LEAFLET FROM THE CURRENT TMAP   
```{r}

```



#### CODE I MAY USE LATER...
```{r}
  #   tm_layout(main.title = "Discharge (GPM) Volume Distribution of Springs in Virginia",
#             main.title.size = 1,
#             title.position = c("center", "TOP"),
#             legend.position = c("left", "center"))+
# tm_compass(type = "arrow", position = c("right", "top")) +
# tm_scale_bar(position = c("left", "top"))


# tmap_save(discharge_map, "VA_discharge_map.html")
 
### creating map points 








# test<- discharge%>%dplyr::select(LATNAD83DD,LONGNAD83D)
# 
# test$DEQ_NUMBER<- NULL
# 
# points <- SpatialPoints(test, proj4string = CRS("+proj=longlat +datum=WGS84"))

### reading in map data for Virginia

DEQ_springs<- read_csv("VDEQ_Springs.csv")

Map_DEQ_springs<- DEQ_springs%>%dplyr::select(LONGNAD83D, LATNAD83DD)%>%drop_na()

Map_DEQ_springs <- SpatialPoints(Map_DEQ_springs, proj4string = CRS("+proj=longlat +datum=WGS84"))

st_crs(Map_DEQ_springs)

###

va <- shapefile("VirginiaAdministrativeBoundary.shp/VirginiaCounty.shp")
st_crs(va)

va_test <- spTransform(va, CRS(proj4string(Map_DEQ_springs)))
st_crs(va_test)

 

### 
 tm_shape(va_test) +
  tm_borders()+
  tm_shape(Map_DEQ_springs)+
  tm_dots(col = "blue")+
tm_add_legend(type = 'symbol',
              labels = c('USGS', 'VADEQ'),
              col = c('red', 'blue'),
              title = "Spring Type",
              is.portrait = TRUE)+
tm_layout(main.title = "USGS and VDEQ Springs in Virginia",
            main.title.size = 1,
            title.position = c("center", "TOP"),
            legend.position = c("left", "center"))+
tm_compass(type = "arrow", position = c("right", "top")) +
tm_scale_bar(position = c("left", "top"))



```

